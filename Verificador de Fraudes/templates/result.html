{% extends "base.html" %}
{% block content %}
<section class="card">
  <a href="{{ url_for('index') }}" class="back">← Nova análise</a>
  <h2>Resultado</h2>

  {% set _meta = meta|default({}) %}

  {% if error %}
    <div class="alert error">{{ error }}</div>
  {% else %}

    <!-- Bloco principal de resultado (topo, alinhado à esquerda) -->
    <div class="resultado-principal" style="text-align:left; margin-bottom:20px; display:flex; flex-direction:column; gap:12px;">
      <div>
        <strong>Resultado:</strong>
        <div class="valor resultado">{{ (label or 'OK')|upper }}</div>
      </div>

      <div>
        <strong>Confiança do veredito</strong>
        <div class="valor">{{ "%.1f"|format(conf_pct|default(0)) }}%</div>
        <div class="bar"><div class="bar-fill conf" style="width: {{ conf_pct|default(0) }}%"></div></div>
      </div>

      <div>
        <strong>Risco estimado</strong>
        <div class="valor">{{ "%.1f"|format(risk_pct|default(0)) }}%</div>
        <div class="bar"><div class="bar-fill risk" style="width: {{ risk_pct|default(0) }}%"></div></div>
      </div>
    </div>

    {# Metadados de origem #}
    {% if _meta.title %}
      <p><strong>Título:</strong> {{ _meta.title }}</p>
    {% endif %}

    {% if _meta.url %}
      <p><strong>URL:</strong>
        <a href="{{ _meta.url }}" target="_blank" rel="noopener">{{ _meta.url }}</a>
      </p>
      {% if _meta.url_accessible is not none %}
        {% if _meta.url_accessible %}
          <p><strong>Status do link:</strong> Acessível (HTTP {{ _meta.status_code }})
            {% if _meta.final_url and _meta.final_url != _meta.url %}
              → redirecionado para {{ _meta.final_url }}
            {% endif %}
          </p>
        {% else %}
          <p><strong>Status do link:</strong> Inacessível — {{ _meta.url_error_human }}</p>
        {% endif %}
      {% endif %}
    {% endif %}

    {% if _meta.subject %}
      <p><strong>Assunto do e-mail:</strong> {{ _meta.subject }}</p>
    {% endif %}
    {% if _meta.from %}
      <p><strong>De:</strong> {{ _meta.from }}</p>
    {% endif %}
    {% if _meta.reply_to %}
      <p><strong>Reply-To:</strong> {{ _meta.reply_to }}</p>
    {% endif %}

    {% if red_flags and red_flags|length>0 %}
      <h3>Sinais observados</h3>
      <ul>
        {% for f in red_flags %}
          <li>{{ f }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if explanation %}
      <h3>Resumo da análise</h3>
      <p>{{ explanation }}</p>
    {% endif %}

    {% if benign_notes and benign_notes|length > 0 %}
      <h3>Sinais benignos considerados</h3>
      <ul>
        {% for b in benign_notes %}
          <li>{{ b }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if actions and actions|length>0 %}
      <h3>O que fazer agora</h3>
      <ol>
        {% for a in actions %}
          <li>{{ a }}</li>
        {% endfor %}
      </ol>
    {% endif %}

    <h3>Trecho analisado</h3>
    {{ snippet }}

    {% if _meta.ocr_debug and _meta.ocr_debug|length > 0 %}
      <h3>Debug do OCR</h3>
      <div style="display:flex; flex-wrap: wrap; gap: 8px;">
        {% for p in _meta.ocr_debug %}
          <a href="{{ p }}" target="_blank" rel="noopener">
            <img src="{{ p }}" alt="debug ocr" style="height:120px; border:1px solid #2a3144; border-radius:6px;">
          </a>
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}
</section>
{% endblock %}
